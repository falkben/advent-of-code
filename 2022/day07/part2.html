<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="../../output.css" rel="stylesheet" />
    <link href="../../pygments.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/pyodide/v0.18.1/full/pyodide.js"></script>
  </head>
  <body>
    <div class="p-2">
      <div class="text-lg"><a href="../../">Index</a></div>
      <h1 class="text-2xl font-bold underline">
          Day 07
      </h1>
      <h2 class="text-xl italic">
        part2
      </h2>
      <div>AoC <a href="https://adventofcode.com/2022/day/7" target="_blank">
        link</a>
      </div>
      <div class="flex space-x-2 mt-3">
        <div class="w-2/3 overflow-x-auto"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="nb">input</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">$ cd /</span>
<span class="s2">$ ls</span>
<span class="s2">dir a</span>
<span class="s2">14848514 b.txt</span>
<span class="s2">8504156 c.dat</span>
<span class="s2">dir d</span>
<span class="s2">$ cd a</span>
<span class="s2">$ ls</span>
<span class="s2">dir e</span>
<span class="s2">29116 f</span>
<span class="s2">2557 g</span>
<span class="s2">62596 h.lst</span>
<span class="s2">$ cd e</span>
<span class="s2">$ ls</span>
<span class="s2">584 i</span>
<span class="s2">$ cd ..</span>
<span class="s2">$ cd ..</span>
<span class="s2">$ cd d</span>
<span class="s2">$ ls</span>
<span class="s2">4060174 j</span>
<span class="s2">8033020 d.log</span>
<span class="s2">5626152 d.ext</span>
<span class="s2">7214296 k</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">input</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;2022/day07/data.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">File</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Dir</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parent</span><span class="p">:</span> <span class="s2">&quot;Dir&quot;</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">children</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">File</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>


<span class="n">directories</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">cur_dir</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">:</span>
        <span class="c1"># command, either ls or cd</span>

        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;$ cd ..&quot;</span><span class="p">:</span>
            <span class="n">cur_dir</span> <span class="o">=</span> <span class="n">cur_dir</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;$ ls&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cur_dir</span> <span class="o">=</span> <span class="n">Dir</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="n">parent</span><span class="o">=</span><span class="n">cur_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cur_dir</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cur_dir</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_dir</span><span class="p">)</span>
            <span class="n">directories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_dir</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># listing:</span>
        <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span>
            <span class="c1"># ignore</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># file to add to current directory</span>
            <span class="n">cur_dir</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>


<span class="k">def</span> <span class="nf">calc_dir_size</span><span class="p">(</span><span class="nb">dir</span><span class="p">:</span> <span class="n">Dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">dir</span><span class="o">.</span><span class="n">files</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">dir</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">calc_dir_size</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">size</span>


<span class="n">total_disk_space</span> <span class="o">=</span> <span class="mi">70_000_000</span>
<span class="n">required_unused</span> <span class="o">=</span> <span class="mi">30_000_000</span>

<span class="n">total_space_used</span> <span class="o">=</span> <span class="n">calc_dir_size</span><span class="p">(</span><span class="n">directories</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">unused_space</span> <span class="o">=</span> <span class="n">total_disk_space</span> <span class="o">-</span> <span class="n">total_space_used</span>
<span class="n">size_to_free</span> <span class="o">=</span> <span class="n">required_unused</span> <span class="o">-</span> <span class="n">unused_space</span>

<span class="c1"># calc sizes:</span>
<span class="n">dir_sizes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">calc_dir_size</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ss</span> <span class="o">&gt;=</span> <span class="n">size_to_free</span><span class="p">:</span>
        <span class="n">dir_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dir_sizes</span><span class="p">))</span>
</pre></div>
</div>
        <div class="w-1/3">
          <textarea class="hidden" id="code" type="text">from __future__ import annotations

from dataclasses import dataclass, field

input = """\
$ cd /
$ ls
dir a
14848514 b.txt
8504156 c.dat
dir d
$ cd a
$ ls
dir e
29116 f
2557 g
62596 h.lst
$ cd e
$ ls
584 i
$ cd ..
$ cd ..
$ cd d
$ ls
4060174 j
8033020 d.log
5626152 d.ext
7214296 k
"""
input = open("2022/day07/data.txt").read()


@dataclass
class File:
    name: str
    size: int


@dataclass
class Dir:
    name: str
    parent: "Dir" | None = None
    children: list["Dir"] = field(default_factory=list)
    files: list[File] = field(default_factory=list)


directories = []

cur_dir = None
for line in input.splitlines():
    parts = line.split()
    if parts[0] == "$":
        # command, either ls or cd

        if line == "$ cd ..":
            cur_dir = cur_dir.parent
        elif line == "$ ls":
            continue
        else:
            cur_dir = Dir(name=line[5:], parent=cur_dir)
            if cur_dir.parent is not None:
                cur_dir.parent.children.append(cur_dir)
            directories.append(cur_dir)

    else:
        # listing:
        if parts[0] == "dir":
            # ignore
            continue
        else:
            # file to add to current directory
            cur_dir.files.append(File(name=parts[1], size=int(parts[0])))


def calc_dir_size(dir: Dir) -> int:
    size = sum([f.size for f in dir.files])
    for child in dir.children:
        size += calc_dir_size(child)
    return size


total_disk_space = 70_000_000
required_unused = 30_000_000

total_space_used = calc_dir_size(directories[0])
unused_space = total_disk_space - total_space_used
size_to_free = required_unused - unused_space

# calc sizes:
dir_sizes = []
for dir in directories:
    ss = calc_dir_size(dir)
    if ss >= size_to_free:
        dir_sizes.append(ss)

print(min(dir_sizes))
</textarea>
          <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
            onclick="evaluatePython()">Run</button>
          <br />
          <br />
          <div>Output:</div>
          <textarea id="output" style="width: 100%;" rows="6" disabled></textarea>
        </div>
      </div>
    </div>

    <script>
      const output = document.getElementById("output");
      const code = document.getElementById("code");

      function addToOutput(s) {
        output.value += s + "\n";
      }

      output.value = "Initializing...\n";
      // init Pyodide
      async function main() {
        let pyodide = await loadPyodide({
          indexURL: "https://cdn.jsdelivr.net/pyodide/v0.18.1/full/",
        });
        output.value += "Ready!\n";
        return pyodide;
      }
      let pyodideReadyPromise = main();

      async function evaluatePython() {
        let pyodide = await pyodideReadyPromise;
        try {
          await pyodide.loadPackagesFromImports(code.value);
          pyodide.runPython(code.value);
          addToOutput(pyodide.globals.get('return_value'));
        } catch (err) {
          addToOutput(err);
        }
      }
    </script>
  </body>
</html>